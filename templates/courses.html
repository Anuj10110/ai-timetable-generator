<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Courses - AI Timetable Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/utilities.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/admin_common.css') }}" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <button class="mobile-nav-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>
    
    <nav class="navbar-sidebar navbar-dark" id="sidebar">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <i class="fas fa-calendar-alt"></i>
                <span class="brand-text">AI Timetable</span>
            </a>
            
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('dashboard') }}">
                        <i class="fas fa-home"></i>
                        <span class="nav-text">Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('courses') }}">
                        <i class="fas fa-book"></i>
                        <span class="nav-text">Courses</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('faculty') }}">
                        <i class="fas fa-users"></i>
                        <span class="nav-text">Faculty</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('classrooms') }}">
                        <i class="fas fa-door-open"></i>
                        <span class="nav-text">Classrooms</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('batches') }}">
                        <i class="fas fa-users-cog"></i>
                        <span class="nav-text">Batches</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('generate_timetable') }}">
                        <i class="fas fa-cog"></i>
                        <span class="nav-text">Generate</span>
                    </a>
                </li>
            </ul>
            
            <div class="dropdown">
                <a class="dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                    <i class="fas fa-user"></i>
                    <span class="nav-text">{{ user.username if user else 'Admin' }}</span>
                </a>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{{ url_for('logout') }}">
                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                    </a></li>
                </ul>
            </div>
        </div>
    </nav>
    
    <div class="container main-content">
        <div class="row">
            <div class="col-md-8">
                <div class="content-card">
                    <h4 class="mb-4">
                        <i class="fas fa-list me-2 text-primary"></i>Course List
                    </h4>
                    
                    {% if courses %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Name</th>
                                    <th>Department</th>
                                    <th>Type</th>
                                    <th>Credits</th>
                                    <th>Students</th>
                                    <th>Sessions/Week</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for course in courses %}
                                <tr>
                                    <td><strong>{{ course.code }}</strong></td>
                                    <td>{{ course.name }}</td>
                                    <td>{{ course.department }}</td>
                                    <td>
                                        <span class="badge course-type-{{ course.course_type.lower() }}">
                                            {{ course.course_type }}
                                        </span>
                                    </td>
                                    <td>{{ course.credits }}</td>
                                    <td>{{ course.enrolled_students }}</td>
                                    <td>{{ course.sessions_per_week }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-book fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No courses added yet</h5>
                        <p class="text-muted">Add your first course using the form on the right.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="content-card">
                    <h4 class="mb-4">
                        <i class="fas fa-plus me-2 text-primary"></i>Add New Course
                    </h4>
                    
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                    
                    <form method="POST" action="{{ url_for('add_course') }}">
                        <div class="mb-3">
                            <label class="form-label">Course Code</label>
                            <input type="text" class="form-control" name="code" required 
                                   placeholder="e.g., CS101" maxlength="10">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Course Name</label>
                            <input type="text" class="form-control" name="name" required 
                                   placeholder="e.g., Introduction to Computer Science">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Department</label>
                            <select class="form-select" name="department" required>
                                <option value="">Select Department</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Mathematics">Mathematics</option>
                                <option value="Physics">Physics</option>
                                <option value="Chemistry">Chemistry</option>
                                <option value="Biology">Biology</option>
                                <option value="English">English</option>
                                <option value="Business">Business</option>
                                <option value="Engineering">Engineering</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Semester</label>
                            <select class="form-select" name="semester" required>
                                <option value="">Select Semester</option>
                                <option value="Fall 2024">Fall 2024</option>
                                <option value="Spring 2024">Spring 2024</option>
                                <option value="Summer 2024">Summer 2024</option>
                            </select>
                        </div>
                        
                        <div class="row">
                            <div class="col-6">
                                <div class="mb-3">
                                    <label class="form-label">Credits</label>
                                    <input type="number" class="form-control" name="credits" 
                                           required min="1" max="6" value="3">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    <label class="form-label">Course Type</label>
                                    <select class="form-select" name="course_type" required>
                                        <option value="Lecture">Lecture</option>
                                        <option value="Lab">Lab</option>
                                        <option value="Tutorial">Tutorial</option>
                                        <option value="Seminar">Seminar</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Enrolled Students</label>
                            <input type="number" class="form-control" name="enrolled_students" 
                                   required min="1" max="500" value="30">
                        </div>
                        
                        <div class="row">
                            <div class="col-6">
                                <div class="mb-3">
                                    <label class="form-label">Duration (minutes)</label>
                                    <select class="form-select" name="duration" required>
                                        <option value="50">50 minutes</option>
                                        <option value="75">75 minutes</option>
                                        <option value="90" selected>90 minutes</option>
                                        <option value="120">120 minutes</option>
                                        <option value="180">180 minutes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    <label class="form-label">Sessions per Week</label>
                                    <select class="form-select" name="sessions_per_week" required>
                                        <option value="1">1</option>
                                        <option value="2" selected>2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Faculty ID (optional)</label>
                            <input type="text" class="form-control" name="faculty_id" 
                                   placeholder="Leave empty for auto-assignment">
                            <div class="form-text">
                                If left empty, system will assign available faculty from the same department.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Required Equipment (optional)</label>
                            <input type="text" class="form-control" name="required_equipment" 
                                   placeholder="Projector, Computers, Lab Equipment (comma-separated)">
                        </div>
                        
                        <!-- Enhanced Parameters -->
                        <div class="mb-3">
                            <label class="form-label">Assigned Batches</label>
                            <div class="form-check-container" style="max-height: 150px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 8px;">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="allBatches" checked>
                                    <label class="form-check-label" for="allBatches">
                                        <strong>All Available Batches</strong>
                                    </label>
                                </div>
                                <hr class="my-2">
                                <div id="batchesList">
                                    <!-- Batches will be loaded here via JavaScript -->
                                </div>
                            </div>
                            <div class="form-text">Select which student batches will take this course</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-6">
                                <div class="mb-3">
                                    <label class="form-label">Max Sessions per Day</label>
                                    <select class="form-select" name="sessions_per_day">
                                        <option value="1" selected>1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    <label class="form-label">Subject Priority</label>
                                    <select class="form-select" name="is_core_subject">
                                        <option value="true" selected>Core Subject</option>
                                        <option value="false">Elective Subject</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="requires_consecutive_sessions" id="consecutiveSessions">
                                <label class="form-check-label" for="consecutiveSessions">
                                    Requires Consecutive Sessions
                                </label>
                            </div>
                            <div class="form-text">Check this for lab sessions that need to be scheduled back-to-back</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Minimum Gap Between Sessions (hours)</label>
                            <select class="form-select" name="minimum_gap_between_sessions">
                                <option value="0" selected>No gap required</option>
                                <option value="1">1 hour</option>
                                <option value="2">2 hours</option>
                                <option value="4">4 hours</option>
                                <option value="24">At least 1 day</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100" onclick="submitCourseForm(event)">
                            <i class="fas fa-plus me-2"></i>Add Course
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show');
        }
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const toggleBtn = document.querySelector('.mobile-nav-toggle');
                
                if (!sidebar.contains(event.target) && !toggleBtn.contains(event.target)) {
                    sidebar.classList.remove('show');
                }
            }
        });
        // Load batches when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadBatches();
            setupBatchSelection();
        });
        
        async function loadBatches() {
            try {
                const response = await fetch('/api/batches');
                const data = await response.json();
                const batches = data.batches || [];
                
                const batchesList = document.getElementById('batchesList');
                batchesList.innerHTML = '';
                
                if (batches.length === 0) {
                    batchesList.innerHTML = '<p class="text-muted small">No batches available. Please add batches first.</p>';
                    return;
                }
                
                batches.forEach(batch => {
                    const checkboxHtml = `
                        <div class="form-check">
                            <input class="form-check-input batch-checkbox" type="checkbox" 
                                   value="${batch.id}" id="batch_${batch.id}" checked>
                            <label class="form-check-label" for="batch_${batch.id}">
                                ${batch.name} <small class="text-muted">(${batch.student_count} students)</small>
                            </label>
                        </div>
                    `;
                    batchesList.insertAdjacentHTML('beforeend', checkboxHtml);
                });
            } catch (error) {
                console.error('Error loading batches:', error);
                document.getElementById('batchesList').innerHTML = '<p class="text-danger small">Error loading batches</p>';
            }
        }
        
        function setupBatchSelection() {
            const allBatchesCheckbox = document.getElementById('allBatches');
            
            allBatchesCheckbox.addEventListener('change', function() {
                const batchCheckboxes = document.querySelectorAll('.batch-checkbox');
                batchCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
            
            // Handle individual batch checkbox changes
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('batch-checkbox')) {
                    updateAllBatchesState();
                }
            });
        }
        
        function updateAllBatchesState() {
            const allBatchesCheckbox = document.getElementById('allBatches');
            const batchCheckboxes = document.querySelectorAll('.batch-checkbox');
            const checkedCount = document.querySelectorAll('.batch-checkbox:checked').length;
            
            if (checkedCount === 0) {
                allBatchesCheckbox.indeterminate = false;
                allBatchesCheckbox.checked = false;
            } else if (checkedCount === batchCheckboxes.length) {
                allBatchesCheckbox.indeterminate = false;
                allBatchesCheckbox.checked = true;
            } else {
                allBatchesCheckbox.indeterminate = true;
                allBatchesCheckbox.checked = false;
            }
        }
        
        function submitCourseForm(event) {
            // Add hidden inputs for selected batches
            const form = event.target.form;
            const selectedBatches = document.querySelectorAll('.batch-checkbox:checked');
            
            // Remove existing batch inputs
            const existingBatchInputs = form.querySelectorAll('input[name^="selected_batches"]');
            existingBatchInputs.forEach(input => input.remove());
            
            // Add new batch inputs
            selectedBatches.forEach(checkbox => {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'selected_batches';
                hiddenInput.value = checkbox.value;
                form.appendChild(hiddenInput);
            });
            
            return true; // Allow form submission
        }
    </script>
</body>
</html>
